<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修ActiveMQ学习总结------Spring整合ActiveMQ 04' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>ActiveMQ学习总结------Spring整合ActiveMQ 04</center></div><div class='banquan'>原文出处:本文由博客园博主Arebirth提供。<br/>
原文连接:https://www.cnblogs.com/arebirth/p/activemq04.html</div><br>
    <h2><span style="font-family: 黑体;">通过前几篇的学习，相信大家已经对我们的ActiveMQ的原生操作已经有了个深刻的概念，</span></h2>
<h2><span style="font-family: 黑体;">那么这篇文章就来带领大家一步一步学习下ActiveMQ结合Spring的实战操作</span></h2>
<hr />
<p><span style="font-family: 黑体;"><strong><span style="color: #ff0000;">注</span>：本文将省略一部分与ActiveMQ无关的spring、mvc等代码，学习者需有SSM框架基础</strong></span></p>
<p><span style="font-family: 黑体;"><strong>　　所有的注释均写在代码里面，请阅读代码并多多阅读注释！</strong></span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<h2><span style="font-family: 黑体;"><strong>一 创建生产者</strong></span></h2>
<blockquote>
<p><span style="font-family: 黑体;"><strong>1 所需依赖jar包</strong></span></p>
<src class="cnblogs_code">
<pre><code><span style="font-family: 黑体;"><strong>　　　　 &lt;activemq.version&gt;5.9.0&lt;/activemq.version&gt;
        &lt;xbean.version&gt;4.5&lt;/xbean.version&gt;
        &lt;jms.version&gt;4.1.6.RELEASE&lt;/jms.version&gt;
        &lt;activemq-pool.version&gt;5.9.0&lt;/activemq-pool.version&gt;</strong></span></code></pre>
<pre><code><span style="font-family: 黑体;">&lt;!-- ActiveMQ客户端完整jar包依赖 --&gt;</span><br /><span style="font-family: 黑体;">&lt;dependency&gt;</span><br /><span style="font-family: 黑体;">    &lt;groupId&gt;org.apache.activemq&lt;/groupId&gt;</span><br /><span style="font-family: 黑体;">    &lt;artifactId&gt;activemq-all&lt;/artifactId&gt;</span><br /><span style="font-family: 黑体;">    &lt;version&gt;${activemq.version}&lt;/version&gt;</span><br /><span style="font-family: 黑体;">&lt;/dependency&gt;</span><br /><span style="font-family: 黑体;">&lt;!-- ActiveMQ和Spring整合配置文件标签处理jar包依赖 --&gt;</span><br /><span style="font-family: 黑体;">&lt;dependency&gt;</span><br /><span style="font-family: 黑体;">    &lt;groupId&gt;org.apache.xbean&lt;/groupId&gt;</span><br /><span style="font-family: 黑体;">    &lt;artifactId&gt;xbean-spring&lt;/artifactId&gt;</span><br /><span style="font-family: 黑体;">    &lt;version&gt;${xbean.version}&lt;/version&gt;</span><br /><span style="font-family: 黑体;">&lt;/dependency&gt;</span><br /><span style="font-family: 黑体;">&lt;!-- Spring-JMS插件相关jar包依赖 --&gt;</span><br /><span style="font-family: 黑体;">&lt;dependency&gt;</span><br /><span style="font-family: 黑体;">    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br /><span style="font-family: 黑体;">    &lt;artifactId&gt;spring-jms&lt;/artifactId&gt;</span><br /><span style="font-family: 黑体;">    &lt;version&gt;${jms.version}&lt;/version&gt;</span><br /><span style="font-family: 黑体;">&lt;/dependency&gt;</span><br /><span style="font-family: 黑体;">&lt;dependency&gt;</span><br /><span style="font-family: 黑体;">    &lt;groupId&gt;org.apache.activemq&lt;/groupId&gt;</span><br /><span style="font-family: 黑体;">    &lt;artifactId&gt;activemq-pool&lt;/artifactId&gt;</span><br /><span style="font-family: 黑体;">    &lt;version&gt;${activemq-pool.version}&lt;/version&gt;</span><br /><span style="font-family: 黑体;">&lt;/dependency&gt;</span><br /><span style="font-family: 黑体;">&lt;dependency&gt;</span><br /><span style="font-family: 黑体;">    &lt;groupId&gt;org.apache.activemq&lt;/groupId&gt;</span><br /><span style="font-family: 黑体;">    &lt;artifactId&gt;activemq-jms-pool&lt;/artifactId&gt;</span><br /><span style="font-family: 黑体;">    &lt;version&gt;${activemq-pool.version}&lt;/version&gt;</span><br /><span style="font-family: 黑体;">&lt;/dependency&gt;</span></code></pre>

<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;"><strong>2.配置与spring整合的配置文件</strong></span></p>
<src class="cnblogs_code">
<pre><code><span style="font-family: 黑体;"><span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version="1.0" encoding="UTF-8"</span><span style="color: #0000ff;">?&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">beans </span><span style="color: #ff0000;">xmlns</span><span style="color: #0000ff;">="http://www.springframework.org/schema/beans"</span><span style="color: #ff0000;">
       xmlns:xsi</span><span style="color: #0000ff;">="http://www.w3.org/2001/XMLSchema-instance"</span><span style="color: #ff0000;">
       xmlns:amq</span><span style="color: #0000ff;">="http://activemq.apache.org/schema/core"</span><span style="color: #ff0000;">
       xsi:schemaLocation</span><span style="color: #0000ff;">="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://activemq.apache.org/schema/core
        http://activemq.apache.org/schema/core/activemq-core.xsd"</span><span style="color: #0000ff;">&gt;</span>

    <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">
        需要创建一个链接工厂，链接ActiveMQ，ActiveMQConnectionFactory
        需要依赖ActiveMQ提供的amq标签

        amq:connectionFactory 是bean标签的子标签，会在spring容器中创建一个bean对象，
        可以为对象命名为
            类似：&lt;bean id="" class="ActiveMQConnectionFactory" /&gt;

        所以我们这里边使用简便的方式amq:connectionFactory
        </span><span style="color: #008000;">--&gt;</span>
    <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">  &lt;bean id="connectionFactory" class="org.apache.activemq.ActiveMQConnectionFactory"&gt;
          &lt;property name="brokerURL" value="tcp://169.254.18.20:61616"/&gt;
          &lt;property name="userName" value="admin"/&gt;
          &lt;property name="password" value="admin"/&gt;
      &lt;/bean&gt;</span><span style="color: #008000;">--&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">amq:connectionFactory </span><span style="color: #ff0000;">brokerURL</span><span style="color: #0000ff;">="tcp://169.254.18.20:61616"</span><span style="color: #ff0000;">
                           userName</span><span style="color: #0000ff;">="admin"</span><span style="color: #ff0000;"> password</span><span style="color: #0000ff;">="admin"</span><span style="color: #ff0000;"> id</span><span style="color: #0000ff;">="amqConnectionFactory"</span><span style="color: #0000ff;">/&gt;</span>


    <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">
        配置池化的ConnectionFactory，为链接ActiveMQ的connectionFactory提供连接池
        我们一般不直接用链接工厂，原因是：这个connectionFactory不会复用connection、session、produce
            consumer，每次连接都需要重新创建conneciton，再创建session，然后调用session创建新的
            producer或者consumer然后用完之后依次关闭，比较浪费资源。
        我们一般用这个链接工厂作为其他拥有更高级（缓存）的链接工厂的参数。

        又因为PooledConnectionFactory会缓存conneciton，session，producer，不会缓存consumer，所以更适合发送者
      </span><span style="color: #008000;">--&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">="pooledConnectionFactory"</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">="org.apache.activemq.pool.PooledConnectionFactory"</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">引用上面的链接工厂</span><span style="color: #008000;">--&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="connectionFactory"</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">="amqConnectionFactory"</span><span style="color: #0000ff;">/&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">连接数量</span><span style="color: #008000;">--&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="maxConnections"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="10"</span><span style="color: #0000ff;">/&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">超时时间，最后使用时间+idleTimeout &gt; 当前时间,连接关闭</span><span style="color: #008000;">--&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="idleTimeout"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="30000"</span><span style="color: #0000ff;">/&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">回收时间，连接创建时间+expirtyTimeout &gt; 当前时间，连接关闭</span><span style="color: #008000;">--&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="expiryTimeout"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="30000"</span><span style="color: #0000ff;">/&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">如果连接池是满的，则阻塞</span><span style="color: #008000;">--&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="blockIfSessionPoolIsFull"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="true"</span><span style="color: #0000ff;">/&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> 每个链接最大的session(会话)数量</span><span style="color: #008000;">--&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="maximumActiveSessionPerConnection"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="10"</span><span style="color: #0000ff;">/&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span>

    <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">
        Spring管理JMS相关代码的时候，必须依赖jms标签库、spring-jms提供的标签库

        定义Spring-JMS中的连接工厂对象 CachingConnectionFactory -spring框架提供的连接工厂对象
        不能真正的访问MOM容器，类似一个工厂的代理对象  需要提供一个真实工厂，实现MOM
        容器的连接访问

        配置有缓存的ConnectionFactory，session的缓存大小可以指定

        默认情况下cachingConnnectionFactory之缓存一个session，针对低并发足够了
    </span><span style="color: #008000;">--&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">="connectionFactory"</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">="org.springframework.jms.connection.CachingConnectionFactory"</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="targetConnectionFactory"</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">="amqConnectionFactory"</span><span style="color: #0000ff;">/&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="sessionCacheSize"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="3"</span><span style="color: #0000ff;">/&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span>

    <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">  jmsTemplate 点对点  </span><span style="color: #008000;">--&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">="jmsQuequTemplate"</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">="org.springframework.jms.core.JmsTemplate"</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">     给定连接工厂，必须是spring创建的连接工厂   </span><span style="color: #008000;">--&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="connectionFactory"</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">="connectionFactory"</span><span style="color: #0000ff;">/&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">     可选  默认目的地命名   </span><span style="color: #008000;">--&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="defaultDestinationName"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="test-spring-topic"</span><span style="color: #0000ff;">/&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> 设置消息确认机制-
             * * Session.AUTO_ACKNOWLEDGE:自动消息确认机制
             * * Session.CLIENT_ACKNOWLEDGE:客户端确认机制
             * * Session.DUPS_OK_ACKNOWLEDGE:由副本的客户端确认消息机制
        </span><span style="color: #008000;">--&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="sessionAcknowledgeModeName"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="AUTO_ACKNOWLEDGE"</span><span style="color: #0000ff;">/&gt;</span>

        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">开启事务，则Ack无效</span><span style="color: #008000;">--&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">        &lt;property name="sessionTransacted" value="true"/&gt;</span><span style="color: #008000;">--&gt;</span>

        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> 由于receive方法时同步的，所以这里对接收设置超时时间</span><span style="color: #008000;">--&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="receiveTimeout"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="60000"</span><span style="color: #0000ff;">/&gt;</span>

        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">    开启订阅    </span><span style="color: #008000;">--&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">        &lt;property name="pubSubDomain" value="true"/&gt;</span><span style="color: #008000;">--&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span>

    <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">  jmsTemplate Topic模式  </span><span style="color: #008000;">--&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">="jmsTopicTemplate"</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">="org.springframework.jms.core.JmsTemplate"</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">     给定连接工厂，必须是spring创建的连接工厂   </span><span style="color: #008000;">--&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="connectionFactory"</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">="connectionFactory"</span><span style="color: #0000ff;">/&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">     可选  默认目的地命名   </span><span style="color: #008000;">--&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="defaultDestinationName"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="test-spring-topic"</span><span style="color: #0000ff;">/&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> 设置消息确认机制-
             * * Session.AUTO_ACKNOWLEDGE:自动消息确认机制
             * * Session.CLIENT_ACKNOWLEDGE:客户端确认机制
             * * Session.DUPS_OK_ACKNOWLEDGE:由副本的客户端确认消息机制
        </span><span style="color: #008000;">--&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="sessionAcknowledgeModeName"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="AUTO_ACKNOWLEDGE"</span><span style="color: #0000ff;">/&gt;</span>

        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">开启事务，则Ack无效</span><span style="color: #008000;">--&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">&lt;property name="sessionTransacted" value="true"/&gt;</span><span style="color: #008000;">--&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> 开启订阅 也就是Topic模式</span><span style="color: #008000;">--&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="pubSubDomain"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="true"</span><span style="color: #0000ff;">/&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span>

    <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">  JMSTemplate消息生产者  </span><span style="color: #008000;">--&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">="producer"</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">="cn.arebirth.mq.provider.Producer"</span><span style="color: #0000ff;">/&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">beans</span><span style="color: #0000ff;">&gt;</span></span></code></pre>

<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;"><strong>3 为了松耦合抽取出provider</strong></span></p>
<src class="cnblogs_code">
<pre><code><span style="color: #000000; font-family: 黑体;">package cn.arebirth.mq.provider;

import org.springframework.jms.core.JmsTemplate;
import org.springframework.jms.core.MessageCreator;

import javax.annotation.Resource;

public class Producer {
    @Resource(name = "jmsTopicTemplate")
    private JmsTemplate jmsTemplate;

    /**
     * 发送消息
     *
     * @param destinationName 目的地名称
     * @param messageCreator  消息
     */
    public void sendMessage(String destinationName, MessageCreator messageCreator) {
        if (null != destinationName) {
            jmsTemplate.send(messageCreator);
            return;
        }
        jmsTemplate.send(destinationName, messageCreator);
    }
}</span></code></pre>

<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;"><strong>4 service</strong></span></p>
<p><span style="font-family: 黑体;"><strong>通过调用自定义的provider，然后使用了里面的匿名类来创建了一个对象消息，</strong></span></p>
<p><span style="font-family: 黑体;"><strong>Uuser为我自己定义的对象，可以任意自定义</strong></span></p>
<src class="cnblogs_code">
<pre><code><span style="font-family: 黑体;"><span style="color: #0000ff;">package</span><span style="color: #000000;"> cn.arebirth.service.impl;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> cn.arebirth.mq.provider.Producer;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> cn.arebirth.pojo.Users;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> cn.arebirth.service.UserService;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.beans.factory.annotation.Autowired;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.jms.core.JmsTemplate;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.jms.core.MessageCreator;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.stereotype.Service;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.jms.JMSException;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.jms.Message;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.jms.Session;

@Service
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> UserServiceImpl <span style="color: #0000ff;">implements</span><span style="color: #000000;"> UserService {

    </span><span style="color: #008000;">//</span><span style="color: #008000;">获取自定义的provider</span>
<span style="color: #000000;">    @Autowired
    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Producer producer;

    @Override
    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> addUser(String destinationName, Users user) {
        producer.sendMessage(destinationName, </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> MessageCreator() {
            @Override
            </span><span style="color: #0000ff;">public</span> Message createMessage(Session session) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> JMSException {
                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> session.createObjectMessage(user);
            }
        });
    }
}</span></span></code></pre>

<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;"><strong>5 Controller</strong></span></p>
<src class="cnblogs_code">
<pre><code><span style="font-family: 黑体;"><span style="color: #000000;">@Controller
@RequestMapping(</span>"/user"<span style="color: #000000;">)
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> UserController {

    @Autowired
    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> UserService userService;
    
    @RequestMapping(</span>"/addUser"<span style="color: #000000;">)
    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> String addUser(Users user){
        </span><span style="color: #0000ff;">this</span>.userService.addUser("test-spring-topic"<span style="color: #000000;">,user);
        </span><span style="color: #0000ff;">return</span> "ok"<span style="color: #000000;">;
    }
}</span></span></code></pre>

<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">然后我们启动tomcat执行，</span></p>
<p><span style="font-family: 黑体;"><img src="./images/ActiveMQ学习总结------Spring整合ActiveMQ 040.png" alt="" /></span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;"><strong>&nbsp;由于我们的是Topic模式，所以我们需要在Topic模式里面查看。</strong></span></p>
<p><span style="font-family: 黑体;"><strong><img src="./images/ActiveMQ学习总结------Spring整合ActiveMQ 041.png" alt="" /></strong></span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;出现这样的内容，证明我们的provider发布成功了！</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
</blockquote>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;"><strong>仔细看上面的配置文件我们可以发现</strong></span></p>
<p><span style="font-family: 黑体;"><strong>jmsQueueTemplate和jmsTopicTemplate还是有区别的</strong></span></p>
<p><span style="font-family: 黑体;"><strong>在我们的topic里面会有这行代码</strong></span></p>
<p><span style="font-family: 黑体;"><strong><img src="./images/ActiveMQ学习总结------Spring整合ActiveMQ 042.png" alt="" /></strong></span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;"><strong>如果pubSubDomain为true则代表为topic模式，false为queue也就是点对点，我们可以看下源码介绍</strong></span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<pre><code><span style="font-family: 黑体;">/**</span><br /><span style="font-family: 黑体;"> * Configure the destination accessor with knowledge of the JMS domain used.</span><br /><span style="font-family: 黑体;"> *<span style="color: #ff0000;"> Default is Point-to-Point (Queues).  默认为点对点也就是queue模式</span></span><br /><span style="font-family: 黑体;"> * &lt;p&gt;This setting primarily indicates what type of destination to resolve</span><br /><span style="font-family: 黑体;"> * if dynamic destinations are enabled.</span><br /><span style="font-family: 黑体;"> * @param <span style="color: #ff0000;">pubSubDomain "true" for the Publish/Subscribe domain</span> ({@link javax.jms.Topic Topics}), </span><br /><span style="font-family: 黑体;"> * "false" for the Point-to-Point domain ({@link javax.jms.Queue Queues})</span><br /><span style="font-family: 黑体;"> * @see #setDestinationResolver</span><br /><span style="font-family: 黑体;"> */</span><br /><span style="font-family: 黑体;">public void setPubSubDomain(boolean pubSubDomain) {</span><br /><span style="font-family: 黑体;">   this.pubSubDomain = pubSubDomain;</span><br /><span style="font-family: 黑体;">}</span><br /><br /><span style="font-family: 黑体;"><strong>这是官方代码介绍，默认是queue模式，设置为true的话就是topic模式</strong></span></code></pre>
<hr />
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<h2><span style="font-family: 黑体;"><strong>二 创建消费者</strong></span></h2>
<blockquote>
<p><span style="font-family: 黑体;"><strong>1 添加pom文件依赖</strong></span></p>
<p><span style="font-family: 黑体;"><strong>与provider不同的是，不需要连接池</strong></span></p>
<src class="cnblogs_code">
<pre><code><span style="font-family: 黑体;"> &lt;activemq.version&gt;5.9.0&lt;/activemq.version&gt;
        &lt;xbean.version&gt;4.5&lt;/xbean.version&gt;
        &lt;jms.version&gt;4.1.6.RELEASE&lt;/jms.version&gt;
&lt;!-- ActiveMQ客户端完整jar包依赖 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.activemq&lt;/groupId&gt;
    &lt;artifactId&gt;activemq-all&lt;/artifactId&gt;
    &lt;version&gt;${activemq.version}&lt;/version&gt;
&lt;/dependency&gt;
&lt;!-- ActiveMQ和Spring整合配置文件标签处理jar包依赖 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.xbean&lt;/groupId&gt;
    &lt;artifactId&gt;xbean-spring&lt;/artifactId&gt;
    &lt;version&gt;${xbean.version}&lt;/version&gt;
&lt;/dependency&gt;
&lt;!-- Spring-JMS插件相关jar包依赖 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework&lt;/groupId&gt;
    &lt;artifactId&gt;spring-jms&lt;/artifactId&gt;
    &lt;version&gt;${jms.version}&lt;/version&gt;
&lt;/dependency&gt;</span></code></pre>

<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;"><strong>2 整合spring的配置文件</strong></span></p>
<src class="cnblogs_code">
<pre><code><span style="font-family: 黑体;"><span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version="1.0" encoding="UTF-8"</span><span style="color: #0000ff;">?&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">beans </span><span style="color: #ff0000;">xmlns</span><span style="color: #0000ff;">="http://www.springframework.org/schema/beans"</span><span style="color: #ff0000;">
       xmlns:xsi</span><span style="color: #0000ff;">="http://www.w3.org/2001/XMLSchema-instance"</span><span style="color: #ff0000;">
       xmlns:jms</span><span style="color: #0000ff;">="http://www.springframework.org/schema/jms"</span><span style="color: #ff0000;">
       xmlns:amq</span><span style="color: #0000ff;">="http://activemq.apache.org/schema/core"</span><span style="color: #ff0000;">
       xsi:schemaLocation</span><span style="color: #0000ff;">="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/jms
        http://www.springframework.org/schema/jms/spring-jms.xsd
        http://activemq.apache.org/schema/core
        http://activemq.apache.org/schema/core/activemq-core.xsd"</span><span style="color: #0000ff;">&gt;</span>

    <span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> 需要创建一个连接工厂,连接ActiveMQ. ActiveMQConnectionFactory. 需要依赖ActiveMQ提供的amq标签 </span><span style="color: #008000;">--&gt;</span>
    <span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> amq:connectionFactory 是bean标签的子标签, 会在spring容器中创建一个bean对象.
        可以为对象命名. 类似: &lt;bean id="" class="ActiveMQConnectionFactory"&gt;&lt;/bean&gt;
     </span><span style="color: #008000;">--&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">amq:connectionFactory </span><span style="color: #ff0000;">brokerURL</span><span style="color: #0000ff;">="tcp://169.254.18.20:61616"</span><span style="color: #ff0000;">
                           userName</span><span style="color: #0000ff;">="admin"</span><span style="color: #ff0000;"> password</span><span style="color: #0000ff;">="admin"</span><span style="color: #ff0000;"> id</span><span style="color: #0000ff;">="amqConnectionFactory"</span><span style="color: #0000ff;">/&gt;</span>

    <span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> spring管理JMS相关代码的时候,必须依赖jms标签库. spring-jms提供的标签库. </span><span style="color: #008000;">--&gt;</span>
    <span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> 定义Spring-JMS中的连接工厂对象
        CachingConnectionFactory - spring框架提供的连接工厂对象. 不能真正的访问MOM容器.
            类似一个工厂的代理对象. 需要提供一个真实工厂,实现MOM容器的连接访问.

        默认情况下，cachingConnectionFactory之缓存一个session，对于低并发足以
     </span><span style="color: #008000;">--&gt;</span>

    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">="connectionFactory"</span><span style="color: #ff0000;">
          class</span><span style="color: #0000ff;">="org.springframework.jms.connection.CachingConnectionFactory"</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="targetConnectionFactory"</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">="amqConnectionFactory"</span><span style="color: #0000ff;">/&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="sessionCacheSize"</span><span style="color: #ff0000;"> value</span><span style="color: #0000ff;">="3"</span><span style="color: #0000ff;">/&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span>

    <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">
        注册监听器      DefaultMessageListenerContainer
        jms:listener-container 相当于DefaultMessageListenerContainer
        负责将messageListener注册到connectionFactory的destination，
        一旦destination中有消息，就会将消息推送给messageListener
        开始注册监听：
        需要的参数有：
            acknowledge -消息确认机制
            container-type 容器类型 default|simple
                simple:SimpleMessageListenerContainer最简单的消息监听容器，只能处理固定数量的JMS会话，而且不支持事务
                default:DefaultMessageListenerContainer 是一个用于异步消息监听器容器，且支持事务
            destination-type 目的地类型，使用队列作为目的地 queue  topic
            connection-factory 连接工厂，spring-jms使用的连接工厂，必须是spring自主创建的
            不能使用三方工具创建的工程，如：ActiveMQConnectionFactory
    </span><span style="color: #008000;">--&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">jms:listener-container </span><span style="color: #ff0000;">acknowledge</span><span style="color: #0000ff;">="auto"</span><span style="color: #ff0000;"> container-type</span><span style="color: #0000ff;">="default"</span><span style="color: #ff0000;">
                            destination-type</span><span style="color: #0000ff;">="topic"</span><span style="color: #ff0000;">
                            connection-factory</span><span style="color: #0000ff;">="connectionFactory"</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #008000;">&lt;!--</span><span style="color: #008000;"> 在监听容器中注册某监听器对象
            destination -设置目的地命名
            ref-指定监听器对象
            </span><span style="color: #008000;">--&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">jms:listener </span><span style="color: #ff0000;">destination</span><span style="color: #0000ff;">="test-spring-topic"</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">="myListener"</span><span style="color: #0000ff;">/&gt;</span>  <span style="color: #008000;">&lt;!--</span><span style="color: #008000;">这个myListener是我们自定义的一个监听类，下边代码可以看到</span><span style="color: #008000;">--&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">jms:listener-container</span><span style="color: #0000ff;">&gt;</span>

<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">beans</span><span style="color: #0000ff;">&gt;</span></span></code></pre>

<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;"><strong>3 service</strong></span></p>
<p><span style="font-family: 黑体;"><strong>很简单就是一个简单输出</strong></span></p>
<src class="cnblogs_code">
<pre><code><span style="font-family: 黑体;"><span style="color: #0000ff;">package</span><span style="color: #000000;"> cn.arebirth.service.impl;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> cn.arebirth.pojo.Users;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> cn.arebirth.service.UserService;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.stereotype.Service;


@Service
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> UserServiceImpl <span style="color: #0000ff;">implements</span><span style="color: #000000;"> UserService {

    @Override
    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> showUser(Users user) {
        System.out.println(user);
    }

}</span></span></code></pre>

<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;"><strong>4 监听处理消息类Listener</strong></span></p>
<p><span style="font-family: 黑体;"><strong>因为我们在配置文件里面已经引用了此对象，我们只需要实现MessageListener消息监听类即可</strong></span></p>
<src class="cnblogs_code">
<pre><code><span style="font-family: 黑体;"><span style="color: #0000ff;">package</span><span style="color: #000000;"> cn.arebirth.listener;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> cn.arebirth.pojo.Users;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> cn.arebirth.service.UserService;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.beans.factory.annotation.Autowired;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.stereotype.Component;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.jms.JMSException;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.jms.Message;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.jms.MessageListener;
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.jms.ObjectMessage;

</span><span style="color: #008000;">/**</span><span style="color: #008000;">
 * 消息服务监听器
 </span><span style="color: #008000;">*/</span><span style="color: #000000;">
@Component(value </span>= "myListener"<span style="color: #000000;">)
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MyMessageListener <span style="color: #0000ff;">implements</span><span style="color: #000000;"> MessageListener {

    @Autowired
    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> UserService userService;

    @Override
    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onMessage(Message message) {
        </span><span style="color: #008000;">//</span><span style="color: #008000;">处理消息</span>
        ObjectMessage objectMessage =<span style="color: #000000;"> (ObjectMessage) message;
        Users users </span>= <span style="color: #0000ff;">null</span><span style="color: #000000;">;
        </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
            users </span>=<span style="color: #000000;"> (Users) objectMessage.getObject();
        } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (JMSException e) {
            e.printStackTrace();
        }
        </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.userService.showUser(users);

    }
}</span></span></code></pre>

<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;"><strong>5 启动测试</strong></span></p>
<src class="cnblogs_code">
<pre><code><span style="font-family: 黑体;"><span style="color: #0000ff;">package</span><span style="color: #000000;"> cn.arebirth;

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> org.springframework.context.support.ClassPathXmlApplicationContext;

</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Start {
    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {
        String[] content </span>= {"classpath:applicationContext-jms.xml","classpath:applicationContext-service.xml"<span style="color: #000000;">};
        ClassPathXmlApplicationContext context </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> ClassPathXmlApplicationContext(content);
        context.start();
    }
}</span></span></code></pre>

<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">启动后，我们发现没有任何消息啊，是不是代码错了啊！</span></p>
<p><span style="font-family: 黑体;">！！我们的是topic模式，所以我们要先启动consumer，然后在进行发布消息，否则，provider发不完可不管你收不收到的</span></p>
<p><span style="font-family: 黑体;"><img src="./images/ActiveMQ学习总结------Spring整合ActiveMQ 043.png" alt="" /></span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;"><strong>然后我们在重新发布一条消息</strong></span></p>
<p><span style="font-family: 黑体;"><strong>内容</strong></span></p>
<p><span style="font-family: 黑体;"><strong><img src="./images/ActiveMQ学习总结------Spring整合ActiveMQ 044.png" alt="" /></strong></span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">我们来看consumer</span></p>
<p><span style="font-family: 黑体;"><img src="./images/ActiveMQ学习总结------Spring整合ActiveMQ 045.png" alt="" /></span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;"><strong>已经收到消息了，就此我们的整合就已经完毕了</strong></span></p>
</blockquote>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<hr />
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><strong><span style="font-family: 黑体;">我们的具体精华都在配置文件里面，详细的注释也都在里面，需要多看，并且敲一遍，运行一遍，然后在看一遍，你会有新的收货！</span></strong></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><strong><span style="font-family: 黑体;">参考博客：</span></strong></p>
<p><span style="font-family: 黑体;">　　<a href="https://www.cnblogs.com/zackzhuzi/p/10050506.html">https://www.cnblogs.com/zackzhuzi/p/10050506.html</a></span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>
<p><span style="font-family: 黑体;">&nbsp;</span></p>

</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>