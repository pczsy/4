<html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='applicable-device' content='pc'><meta name='keywords' content='电脑,电脑讲解,电脑技术,编程,电脑故障维修Mybaits 源码解析 （十二）----- Mybatis的事务如何被Spring管理？Mybatis和Spring事务中用的Connection是同一个吗？' />
<script src='../../highlight/highlight.pack.js'></script>
<link rel='stylesheet' type='text/css' href='../../highlight/styles/monokai.css'/>

<link rel='stylesheet' href='../../fenxiang/dist/css/share.min.css'>
<script src='../../fenxiang/src/js/social-share.js'></script>
<script src='../../fenxiang/src/js/qrcode.js'></script>

</head><body><script>hljs.initHighlightingOnLoad();</script><script>
var system ={};  
var p = navigator.platform;       
system.win = p.indexOf('Win') == 0;  
system.mac = p.indexOf('Mac') == 0;  
system.x11 = (p == 'X11') || (p.indexOf('Linux') == 0);     
if(system.win||system.mac||system.xll){
document.write("<link href='../css/3.css' rel='stylesheet' type='text/css'>");}else{ document.write("<link href='../css/3wap.css' rel='stylesheet' type='text/css'>");}</script><script src='../../js/3.js'></script><div class='div2'><div class='heading_nav'><ul><div><li><a href='../../index.html'>首页</a></li>
</div><div onclick='hidden1()' >分享</div>
</ul></div></div>
<div id='heading_nav2'> 
<li class='row' >
<div class='social-share' data-mode='prepend'><a href='javascript:' class='social-share-icon icon-heart'></a></div></li></div><script charset='utf-8' src='../../3/js/hengfu.js'></script><script charset='utf-8' src='../../3/js/hengfu2.js'></script><hr><div class='div1'><div class='biaoti'><center>Mybaits 源码解析 （十二）----- Mybatis的事务如何被Spring管理？Mybatis和Spring事务中用的Connection是同一个吗？</center></div><div class='banquan'>原文出处:本文由博客园博主chen_hao提供。<br/>
原文连接:https://www.cnblogs.com/java-chen-hao/p/11839993.html</div><br>
    <p>不知道一些同学有没有这种疑问，为什么Mybtis中要配置dataSource，Spring的事务中也要配置dataSource？那么Mybatis和Spring事务中用的Connection是同一个吗？我们常用配置如下</p>
<src class="cnblogs_code">
<pre><code><span style="color: #008000;">&lt;!--</span><span style="color: #008000;">会话工厂 </span><span style="color: #008000;">--&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">="sqlSessionFactory"</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">="org.mybatis.spring.SqlSessionFactoryBean"</span><span style="color: #0000ff;">&gt;</span>
  <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="dataSource"</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">="dataSource"</span> <span style="color: #0000ff;">/&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span>

<span style="color: #008000;">&lt;!--</span><span style="color: #008000;">spring事务管理 </span><span style="color: #008000;">--&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">bean </span><span style="color: #ff0000;">id</span><span style="color: #0000ff;">="transactionManager"</span><span style="color: #ff0000;"> class</span><span style="color: #0000ff;">="org.springframework.jdbc.datasource.DataSourceTransactionManager"</span><span style="color: #0000ff;">&gt;</span>
  <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">property </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="dataSource"</span><span style="color: #ff0000;"> ref</span><span style="color: #0000ff;">="dataSource"</span> <span style="color: #0000ff;">/&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">bean</span><span style="color: #0000ff;">&gt;</span>

<span style="color: #008000;">&lt;!--</span><span style="color: #008000;">使用注释事务 </span><span style="color: #008000;">--&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">tx:annotation-driven  </span><span style="color: #ff0000;">transaction-manager</span><span style="color: #0000ff;">="transactionManager"</span> <span style="color: #0000ff;">/&gt;</span></code></pre>

<p>看到没，<strong>sqlSessionFactory中配置了</strong><strong>dataSource，</strong><strong>transactionManager也配置了</strong><strong>dataSource，我们来回忆一下</strong><strong>SqlSessionFactoryBean这个类</strong></p>
<src class="cnblogs_code">
<pre><code><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">protected</span> SqlSessionFactory buildSqlSessionFactory() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException {
</span><span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 配置类</span>
<span style="color: #008080;"> 4</span> <span style="color: #000000;">   Configuration configuration;
</span><span style="color: #008080;"> 5</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 解析mybatis-Config.xml文件，
</span><span style="color: #008080;"> 6</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 将相关配置信息保存到configuration</span>
<span style="color: #008080;"> 7</span>    XMLConfigBuilder xmlConfigBuilder = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 8</span>    <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">this</span>.configuration != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;"> 9</span>      configuration = <span style="color: #0000ff;">this</span><span style="color: #000000;">.configuration;
</span><span style="color: #008080;">10</span>      <span style="color: #0000ff;">if</span> (configuration.getVariables() == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;">11</span>        configuration.setVariables(<span style="color: #0000ff;">this</span><span style="color: #000000;">.configurationProperties);
</span><span style="color: #008080;">12</span>      } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">this</span>.configurationProperties != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;">13</span>        configuration.getVariables().putAll(<span style="color: #0000ff;">this</span><span style="color: #000000;">.configurationProperties);
</span><span style="color: #008080;">14</span> <span style="color: #000000;">     }
</span><span style="color: #008080;">15</span>     <span style="color: #008000;">//</span><span style="color: #008000;">资源文件不为空</span>
<span style="color: #008080;">16</span>    } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">this</span>.configLocation != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;">17</span>      <span style="color: #008000;">//</span><span style="color: #008000;">根据configLocation创建xmlConfigBuilder，XMLConfigBuilder构造器中会创建Configuration对象</span>
<span style="color: #008080;">18</span>      xmlConfigBuilder = <span style="color: #0000ff;">new</span> XMLConfigBuilder(<span style="color: #0000ff;">this</span>.configLocation.getInputStream(), <span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">this</span><span style="color: #000000;">.configurationProperties);
</span><span style="color: #008080;">19</span>      <span style="color: #008000;">//</span><span style="color: #008000;">将XMLConfigBuilder构造器中创建的Configuration对象直接赋值给configuration属性</span>
<span style="color: #008080;">20</span>      configuration =<span style="color: #000000;"> xmlConfigBuilder.getConfiguration();
</span><span style="color: #008080;">21</span> <span style="color: #000000;">   } 
</span><span style="color: #008080;">22</span>    
<span style="color: #008080;">23</span>     <span style="color: #008000;">//</span><span style="color: #008000;">略....</span>
<span style="color: #008080;">24</span> 
<span style="color: #008080;">25</span>    <span style="color: #0000ff;">if</span> (xmlConfigBuilder != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;">26</span>      <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;">27</span>        <span style="color: #008000;">//</span><span style="color: #008000;">解析mybatis-Config.xml文件，并将相关配置信息保存到configuration</span>
<span style="color: #008080;">28</span> <span style="color: #000000;">       xmlConfigBuilder.parse();
</span><span style="color: #008080;">29</span>        <span style="color: #0000ff;">if</span><span style="color: #000000;"> (LOGGER.isDebugEnabled()) {
</span><span style="color: #008080;">30</span>          LOGGER.debug("Parsed configuration file: '" + <span style="color: #0000ff;">this</span>.configLocation + "'"<span style="color: #000000;">);
</span><span style="color: #008080;">31</span> <span style="color: #000000;">       }
</span><span style="color: #008080;">32</span>      } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception ex) {
</span><span style="color: #008080;">33</span>        <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> NestedIOException("Failed to parse config resource: " + <span style="color: #0000ff;">this</span><span style="color: #000000;">.configLocation, ex);
</span><span style="color: #008080;">34</span> <span style="color: #000000;">     }
</span><span style="color: #008080;">35</span> <span style="color: #000000;">   }
</span><span style="color: #008080;">36</span>     
<span style="color: #008080;">37</span>    <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">this</span>.transactionFactory == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;">38</span>      <span style="color: #008000;">//</span><span style="color: #008000;">事务默认采用SpringManagedTransaction，这一块非常重要</span>
<span style="color: #008080;">39</span>      <span style="color: #0000ff;">this</span>.transactionFactory = <span style="color: #0000ff;">new</span><span style="color: #000000;"> SpringManagedTransactionFactory();
</span><span style="color: #008080;">40</span> <span style="color: #000000;">   }
</span><span style="color: #008080;">41</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 为sqlSessionFactory绑定事务管理器和数据源
</span><span style="color: #008080;">42</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 这样sqlSessionFactory在创建sqlSession的时候可以通过该事务管理器获取jdbc连接，从而执行SQL</span>
<span style="color: #008080;">43</span>    configuration.setEnvironment(<span style="color: #0000ff;">new</span> Environment(<span style="color: #0000ff;">this</span>.environment, <span style="color: #0000ff;">this</span>.transactionFactory, <span style="color: #0000ff;">this</span><span style="color: #000000;">.dataSource));
</span><span style="color: #008080;">44</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 解析mapper.xml</span>
<span style="color: #008080;">45</span>    <span style="color: #0000ff;">if</span> (!isEmpty(<span style="color: #0000ff;">this</span><span style="color: #000000;">.mapperLocations)) {
</span><span style="color: #008080;">46</span>      <span style="color: #0000ff;">for</span> (Resource mapperLocation : <span style="color: #0000ff;">this</span><span style="color: #000000;">.mapperLocations) {
</span><span style="color: #008080;">47</span>        <span style="color: #0000ff;">if</span> (mapperLocation == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;">48</span>          <span style="color: #0000ff;">continue</span><span style="color: #000000;">;
</span><span style="color: #008080;">49</span> <span style="color: #000000;">       }
</span><span style="color: #008080;">50</span>        <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;">51</span>          <span style="color: #008000;">//</span><span style="color: #008000;"> 解析mapper.xml文件，并注册到configuration对象的mapperRegistry</span>
<span style="color: #008080;">52</span>          XMLMapperBuilder xmlMapperBuilder = <span style="color: #0000ff;">new</span><span style="color: #000000;"> XMLMapperBuilder(mapperLocation.getInputStream(),
</span><span style="color: #008080;">53</span> <span style="color: #000000;">             configuration, mapperLocation.toString(), configuration.getSqlFragments());
</span><span style="color: #008080;">54</span> <span style="color: #000000;">         xmlMapperBuilder.parse();
</span><span style="color: #008080;">55</span>        } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {
</span><span style="color: #008080;">56</span>          <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> NestedIOException("Failed to parse mapping resource: '" + mapperLocation + "'"<span style="color: #000000;">, e);
</span><span style="color: #008080;">57</span>        } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {
</span><span style="color: #008080;">58</span> <span style="color: #000000;">         ErrorContext.instance().reset();
</span><span style="color: #008080;">59</span> <span style="color: #000000;">       }
</span><span style="color: #008080;">60</span> 
<span style="color: #008080;">61</span>        <span style="color: #0000ff;">if</span><span style="color: #000000;"> (LOGGER.isDebugEnabled()) {
</span><span style="color: #008080;">62</span>          LOGGER.debug("Parsed mapper file: '" + mapperLocation + "'"<span style="color: #000000;">);
</span><span style="color: #008080;">63</span> <span style="color: #000000;">       }
</span><span style="color: #008080;">64</span> <span style="color: #000000;">     }
</span><span style="color: #008080;">65</span>    } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">66</span>      <span style="color: #0000ff;">if</span><span style="color: #000000;"> (LOGGER.isDebugEnabled()) {
</span><span style="color: #008080;">67</span>        LOGGER.debug("Property 'mapperLocations' was not specified or no matching resources found"<span style="color: #000000;">);
</span><span style="color: #008080;">68</span> <span style="color: #000000;">     }
</span><span style="color: #008080;">69</span> <span style="color: #000000;">   }
</span><span style="color: #008080;">70</span> 
<span style="color: #008080;">71</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 将Configuration对象实例作为参数，
</span><span style="color: #008080;">72</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 调用sqlSessionFactoryBuilder创建sqlSessionFactory对象实例</span>
<span style="color: #008080;">73</span>    <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">.sqlSessionFactoryBuilder.build(configuration);
</span><span style="color: #008080;">74</span> }</code></pre>

<p>我们看第39行，Mybatis集成Spring后，默认使用的transactionFactory是SpringManagedTransactionFactory，那我们就来看看其获取Transaction的方法</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">private</span><span style="color: #000000;"> SqlSession openSessionFromConnection(ExecutorType execType, Connection connection) {
    </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
      </span><span style="color: #0000ff;">boolean</span><span style="color: #000000;"> autoCommit;
      </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
        autoCommit </span>=<span style="color: #000000;"> connection.getAutoCommit();
      } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (SQLException e) {
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Failover to true, as most poor drivers
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> or databases won't support transactions</span>
        autoCommit = <span style="color: #0000ff;">true</span><span style="color: #000000;">;
      }      
      </span><span style="color: #008000;">//</span><span style="color: #008000;">从configuration中取出environment对象</span>
      <span style="color: #0000ff;">final</span> Environment environment =<span style="color: #000000;"> configuration.getEnvironment();
      </span><span style="color: #008000;">//</span><span style="color: #008000;">从environment中取出TransactionFactory</span>
      <span style="color: #0000ff;">final</span> TransactionFactory transactionFactory =<span style="color: #000000;"> getTransactionFactoryFromEnvironment(environment);
      </span><span style="color: #008000;">//</span><span style="color: #008000;">创建Transaction</span>
      <span style="color: #0000ff;">final</span> Transaction tx =<span style="color: #000000;"> transactionFactory.newTransaction(connection);
      </span><span style="color: #008000;">//</span><span style="color: #008000;">创建包含事务操作的执行器</span>
      <span style="color: #0000ff;">final</span> Executor executor =<span style="color: #000000;"> configuration.newExecutor(tx, execType);
      </span><span style="color: #008000;">//</span><span style="color: #008000;">构建包含执行器的SqlSession</span>
      <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> DefaultSqlSession(configuration, executor, autoCommit);
    } </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {
      </span><span style="color: #0000ff;">throw</span> ExceptionFactory.wrapException("Error opening session.  Cause: " +<span style="color: #000000;"> e, e);
    } </span><span style="color: #0000ff;">finally</span><span style="color: #000000;"> {
      ErrorContext.instance().reset();
    }
}

</span><span style="color: #0000ff;">private</span><span style="color: #000000;"> TransactionFactory getTransactionFactoryFromEnvironment(Environment environment) {
    </span><span style="color: #0000ff;">if</span> (environment == <span style="color: #0000ff;">null</span> || environment.getTransactionFactory() == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
      </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> ManagedTransactionFactory();
    }
    </span><span style="color: #008000;">//</span><span style="color: #008000;">这里返回SpringManagedTransactionFactory</span>
    <span style="color: #0000ff;">return</span><span style="color: #000000;"> environment.getTransactionFactory();
}

@Override
</span><span style="color: #0000ff;">public</span> Transaction newTransaction(DataSource dataSource, TransactionIsolationLevel level, <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> autoCommit) {
    </span><span style="color: #008000;">//</span><span style="color: #008000;">创建SpringManagedTransaction</span>
    <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> SpringManagedTransaction(dataSource);
}</span></code></pre>

<h2>SpringManagedTransaction</h2>
<p>也就是说mybatis的执行事务的事务管理器就切换成了SpringManagedTransaction，下面我们再去看看SpringManagedTransactionFactory类的源码：</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> SpringManagedTransaction <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Transaction {
    </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> Log LOGGER = LogFactory.getLog(SpringManagedTransaction.<span style="color: #0000ff;">class</span><span style="color: #000000;">);
    </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span><span style="color: #000000;"> DataSource dataSource;
    </span><span style="color: #0000ff;">private</span><span style="color: #000000;"> Connection connection;
    </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isConnectionTransactional;
    </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> autoCommit;

    </span><span style="color: #0000ff;">public</span><span style="color: #000000;"> SpringManagedTransaction(DataSource dataSource) {
        Assert.notNull(dataSource, </span>"No DataSource specified"<span style="color: #000000;">);
        </span><span style="color: #0000ff;">this</span>.dataSource =<span style="color: #000000;"> dataSource;
    }

    </span><span style="color: #0000ff;">public</span> Connection getConnection() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> SQLException {
        </span><span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">this</span>.connection == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
            </span><span style="color: #0000ff;">this</span><span style="color: #000000;">.openConnection();
        }

        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">.connection;
    }

    </span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> openConnection() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> SQLException {
        </span><span style="color: #008000;">//</span><span style="color: #008000;">通过DataSourceUtils获取connection，这里和JdbcTransaction不一样</span>
        <span style="color: #0000ff;">this</span>.connection = DataSourceUtils.getConnection(<span style="color: #0000ff;">this</span><span style="color: #000000;">.dataSource);
        </span><span style="color: #0000ff;">this</span>.autoCommit = <span style="color: #0000ff;">this</span><span style="color: #000000;">.connection.getAutoCommit();
        </span><span style="color: #0000ff;">this</span>.isConnectionTransactional = DataSourceUtils.isConnectionTransactional(<span style="color: #0000ff;">this</span>.connection, <span style="color: #0000ff;">this</span><span style="color: #000000;">.dataSource);
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (LOGGER.isDebugEnabled()) {
            LOGGER.debug(</span>"JDBC Connection [" + <span style="color: #0000ff;">this</span>.connection + "] will" + (<span style="color: #0000ff;">this</span>.isConnectionTransactional ? " " : " not ") + "be managed by Spring"<span style="color: #000000;">);
        }

    }

    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> commit() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> SQLException {
        </span><span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">this</span>.connection != <span style="color: #0000ff;">null</span> &amp;&amp; !<span style="color: #0000ff;">this</span>.isConnectionTransactional &amp;&amp; !<span style="color: #0000ff;">this</span><span style="color: #000000;">.autoCommit) {
            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (LOGGER.isDebugEnabled()) {
                LOGGER.debug(</span>"Committing JDBC Connection [" + <span style="color: #0000ff;">this</span>.connection + "]"<span style="color: #000000;">);
            }
            </span><span style="color: #008000;">//</span><span style="color: #008000;">通过connection提交，这里和JdbcTransaction一样</span>
            <span style="color: #0000ff;">this</span><span style="color: #000000;">.connection.commit();
        }

    }

    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> rollback() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> SQLException {
        </span><span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">this</span>.connection != <span style="color: #0000ff;">null</span> &amp;&amp; !<span style="color: #0000ff;">this</span>.isConnectionTransactional &amp;&amp; !<span style="color: #0000ff;">this</span><span style="color: #000000;">.autoCommit) {
            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (LOGGER.isDebugEnabled()) {
                LOGGER.debug(</span>"Rolling back JDBC Connection [" + <span style="color: #0000ff;">this</span>.connection + "]"<span style="color: #000000;">);
            }
            </span><span style="color: #008000;">//</span><span style="color: #008000;">通过connection回滚，这里和JdbcTransaction一样</span>
            <span style="color: #0000ff;">this</span><span style="color: #000000;">.connection.rollback();
        }

    }

    </span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> close() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> SQLException {
        DataSourceUtils.releaseConnection(</span><span style="color: #0000ff;">this</span>.connection, <span style="color: #0000ff;">this</span><span style="color: #000000;">.dataSource);
    }

    </span><span style="color: #0000ff;">public</span> Integer getTimeout() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> SQLException {
        ConnectionHolder holder </span>= (ConnectionHolder)TransactionSynchronizationManager.getResource(<span style="color: #0000ff;">this</span><span style="color: #000000;">.dataSource);
        </span><span style="color: #0000ff;">return</span> holder != <span style="color: #0000ff;">null</span> &amp;&amp; holder.hasTimeout() ? holder.getTimeToLiveInSeconds() : <span style="color: #0000ff;">null</span><span style="color: #000000;">;
    }
}</span></code></pre>

<h3>org.springframework.jdbc.datasource.DataSourceUtils#getConnection</h3>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> Connection getConnection(DataSource dataSource) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> CannotGetJdbcConnectionException {
    </span><span style="color: #0000ff;">try</span><span style="color: #000000;"> {
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> doGetConnection(dataSource);
    }
    </span><span style="color: #0000ff;">catch</span><span style="color: #000000;"> (SQLException ex) {
        </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> CannotGetJdbcConnectionException("Could not get JDBC Connection"<span style="color: #000000;">, ex);
    }
}

</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> Connection doGetConnection(DataSource dataSource) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> SQLException {
    Assert.notNull(dataSource, </span>"No DataSource specified"<span style="color: #000000;">);
    </span><span style="color: #008000;">//</span><span style="color: #008000;">TransactionSynchronizationManager重点！！！有没有很熟悉的感觉？？
    </span><span style="color: #008000;">//</span><span style="color: #008000;">还记得我们前面Spring事务源码的分析吗？@Transaction会创建Connection，并放入ThreadLocal中
    </span><span style="color: #008000;">//</span><span style="color: #008000;">这里从ThreadLocal中获取ConnectionHolder</span>
    ConnectionHolder conHolder =<span style="color: #000000;"> (ConnectionHolder)TransactionSynchronizationManager.getResource(dataSource);
    </span><span style="color: #0000ff;">if</span> (conHolder == <span style="color: #0000ff;">null</span> || !conHolder.hasConnection() &amp;&amp; !<span style="color: #000000;">conHolder.isSynchronizedWithTransaction()) {
        logger.debug(</span>"Fetching JDBC Connection from DataSource"<span style="color: #000000;">);
        </span><span style="color: #008000;">//</span><span style="color: #008000;">如果没有使用@Transaction，那调用Mapper接口方法时，也是通过Spring的方法获取Connection</span>
        Connection con =<span style="color: #000000;"> fetchConnection(dataSource);
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (TransactionSynchronizationManager.isSynchronizationActive()) {
            logger.debug(</span>"Registering transaction synchronization for JDBC Connection"<span style="color: #000000;">);
            ConnectionHolder holderToUse </span>=<span style="color: #000000;"> conHolder;
            </span><span style="color: #0000ff;">if</span> (conHolder == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
                holderToUse </span>= <span style="color: #0000ff;">new</span><span style="color: #000000;"> ConnectionHolder(con);
            } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
                conHolder.setConnection(con);
            }

            holderToUse.requested();
            TransactionSynchronizationManager.registerSynchronization(</span><span style="color: #0000ff;">new</span><span style="color: #000000;"> DataSourceUtils.ConnectionSynchronization(holderToUse, dataSource));
            holderToUse.setSynchronizedWithTransaction(</span><span style="color: #0000ff;">true</span><span style="color: #000000;">);
            </span><span style="color: #0000ff;">if</span> (holderToUse !=<span style="color: #000000;"> conHolder) {
                </span><span style="color: #008000;">//</span><span style="color: #008000;">将获取到的ConnectionHolder放入ThreadLocal中，那么当前线程调用下一个接口，下一个接口使用了Spring事务，那Spring事务也可以直接取到Mybatis创建的Connection
                </span><span style="color: #008000;">//</span><span style="color: #008000;">通过ThreadLocal保证了同一线程中Spring事务使用的Connection和Mapper代理类使用的Connection是同一个</span>
<span style="color: #000000;">                TransactionSynchronizationManager.bindResource(dataSource, holderToUse);
            }
        }

        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> con;
    } </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> {
        conHolder.requested();
        </span><span style="color: #0000ff;">if</span> (!<span style="color: #000000;">conHolder.hasConnection()) {
            logger.debug(</span>"Fetching resumed JDBC Connection from DataSource"<span style="color: #000000;">);
            conHolder.setConnection(fetchConnection(dataSource));
        }

        </span><span style="color: #008000;">//</span><span style="color: #008000;">所以如果我们业务代码使用了@Transaction注解，在Spring中就已经通过dataSource创建了一个Connection并放入ThreadLocal中
        </span><span style="color: #008000;">//</span><span style="color: #008000;">那么当Mapper代理对象调用方法时，通过SqlSession的SpringManagedTransaction获取连接时，就直接获取到了当前线程中Spring事务创建的Connection并返回</span>
        <span style="color: #0000ff;">return</span><span style="color: #000000;"> conHolder.getConnection();
    }
}</span></code></pre>

<p>想看怎么获取connHolder&nbsp;</p>
<h3>org.springframework.transaction.support.TransactionSynchronizationManager#getResource</h3>
<src class="cnblogs_code">
<pre><code><span style="color: #008000;">//</span><span style="color: #008000;">保存数据库连接的ThreadLocal</span>
<span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> ThreadLocal&lt;Map&lt;Object, Object&gt;&gt; resources = <span style="color: #0000ff;">new</span> NamedThreadLocal&lt;&gt;("Transactional resources"<span style="color: #000000;">);
@Nullable
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> Object getResource(Object key) {
    Object actualKey </span>=<span style="color: #000000;"> TransactionSynchronizationUtils.unwrapResourceIfNecessary(key);
    </span><span style="color: #008000;">//</span><span style="color: #008000;">获取ConnectionHolder</span>
    Object value =<span style="color: #000000;"> doGetResource(actualKey);
    ....
    </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> value;
}

@Nullable
</span><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> Object doGetResource(Object actualKey) {
    </span><span style="color: #008000;">/**</span><span style="color: #008000;">
     * 从threadlocal &lt;Map&lt;Object, Object&gt;&gt;中取出来当前线程绑定的map
     * map里面存的是&lt;dataSource,ConnectionHolder&gt;
     </span><span style="color: #008000;">*/</span><span style="color: #000000;">
    Map</span>&lt;Object, Object&gt; map =<span style="color: #000000;"> resources.get();
    </span><span style="color: #0000ff;">if</span> (map == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
        </span><span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;
    }
    </span><span style="color: #008000;">//</span><span style="color: #008000;">map中取出来对应dataSource的ConnectionHolder</span>
    Object value =<span style="color: #000000;"> map.get(actualKey);
    </span><span style="color: #008000;">//</span><span style="color: #008000;"> Transparently remove ResourceHolder that was marked as void...</span>
    <span style="color: #0000ff;">if</span> (value <span style="color: #0000ff;">instanceof</span> ResourceHolder &amp;&amp;<span style="color: #000000;"> ((ResourceHolder) value).isVoid()) {
        map.remove(actualKey);
        </span><span style="color: #008000;">//</span><span style="color: #008000;"> Remove entire ThreadLocal if empty...</span>
        <span style="color: #0000ff;">if</span><span style="color: #000000;"> (map.isEmpty()) {
            resources.remove();
        }
        value </span>= <span style="color: #0000ff;">null</span><span style="color: #000000;">;
    }
    </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> value;
}</span></code></pre>

<p>我们看到直接从ThreadLocal中取出来的conn,而spring自己的事务也是操作的这个ThreadLocal中的conn来进行事务的开启和回滚，由此我们知道了在同一线程中Spring事务中的Connection和Mybaits中Mapper代理对象中操作数据库的Connection是同一个，当取出来的conn为空时候,调用org.springframework.jdbc.datasource.DataSourceUtils#fetchConnection获取，然后把从数据源取出来的连接返回</p>
<src class="cnblogs_code">
<pre><code><span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> Connection fetchConnection(DataSource dataSource) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> SQLException {
    </span><span style="color: #008000;">//</span><span style="color: #008000;">从数据源取出来conn</span>
    Connection con =<span style="color: #000000;"> dataSource.getConnection();
    </span><span style="color: #0000ff;">if</span> (con == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
        </span><span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> IllegalStateException("DataSource returned null from getConnection(): " +<span style="color: #000000;"> dataSource);
    }
    </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> con;
}</span></code></pre>

<p>我们再来回顾一下上篇文章中的SqlSessionInterceptor</p>
<src class="cnblogs_code">
<pre><code><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">class</span> SqlSessionInterceptor <span style="color: #0000ff;">implements</span><span style="color: #000000;"> InvocationHandler {
</span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> SqlSessionInterceptor() {
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">public</span> Object invoke(Object proxy, Method method, Object[] args) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Throwable {
</span><span style="color: #008080;"> 6</span>         SqlSession sqlSession = SqlSessionUtils.getSqlSession(SqlSessionTemplate.<span style="color: #0000ff;">this</span>.sqlSessionFactory, SqlSessionTemplate.<span style="color: #0000ff;">this</span>.executorType, SqlSessionTemplate.<span style="color: #0000ff;">this</span><span style="color: #000000;">.exceptionTranslator);
</span><span style="color: #008080;"> 7</span> 
<span style="color: #008080;"> 8</span> <span style="color: #000000;">        Object unwrapped;
</span><span style="color: #008080;"> 9</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;">10</span>             Object result =<span style="color: #000000;"> method.invoke(sqlSession, args);
</span><span style="color: #008080;">11</span>            <strong> <span style="color: #008000;">//</span><span style="color: #008000;"> 如果当前操作没有在一个Spring事务中，则手动commit一下
</span><span style="color: #008080;">12</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 如果当前业务没有使用@Transation,那么每次执行了Mapper接口的方法直接commit
</span><span style="color: #008080;">13</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 还记得我们前面讲的Mybatis的一级缓存吗，这里一级缓存不能起作用了，因为每执行一个Mapper的方法，sqlSession都提交了
</span><span style="color: #008080;">14</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> sqlSession提交，会清空一级缓存</span>
<span style="color: #008080;">15</span>             <span style="color: #0000ff;">if</span> (!SqlSessionUtils.isSqlSessionTransactional(sqlSession, SqlSessionTemplate.<span style="color: #0000ff;">this</span><span style="color: #000000;">.sqlSessionFactory)) {
</span><span style="color: #008080;">16</span>                 sqlSession.commit(<span style="color: #0000ff;">true</span><span style="color: #000000;">);
</span><span style="color: #008080;">17</span> <span style="color: #000000;">            }
</span></strong><span style="color: #008080;">18</span> 
<span style="color: #008080;">19</span>             unwrapped =<span style="color: #000000;"> result;
</span><span style="color: #008080;">20</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Throwable var11) {
</span><span style="color: #008080;">21</span>             unwrapped =<span style="color: #000000;"> ExceptionUtil.unwrapThrowable(var11);
</span><span style="color: #008080;">22</span>             <span style="color: #0000ff;">if</span> (SqlSessionTemplate.<span style="color: #0000ff;">this</span>.exceptionTranslator != <span style="color: #0000ff;">null</span> &amp;&amp; unwrapped <span style="color: #0000ff;">instanceof</span><span style="color: #000000;"> PersistenceException) {
</span><span style="color: #008080;">23</span>                 SqlSessionUtils.closeSqlSession(sqlSession, SqlSessionTemplate.<span style="color: #0000ff;">this</span><span style="color: #000000;">.sqlSessionFactory);
</span><span style="color: #008080;">24</span>                 sqlSession = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;">25</span>                 Throwable translated = SqlSessionTemplate.<span style="color: #0000ff;">this</span><span style="color: #000000;">.exceptionTranslator.translateExceptionIfPossible((PersistenceException)unwrapped);
</span><span style="color: #008080;">26</span>                 <span style="color: #0000ff;">if</span> (translated != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;">27</span>                     unwrapped =<span style="color: #000000;"> translated;
</span><span style="color: #008080;">28</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">29</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">30</span> 
<span style="color: #008080;">31</span>             <span style="color: #0000ff;">throw</span><span style="color: #000000;"> (Throwable)unwrapped;
</span><span style="color: #008080;">32</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {
</span><span style="color: #008080;">33</span>             <span style="color: #0000ff;">if</span> (sqlSession != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;">34</span>                 SqlSessionUtils.closeSqlSession(sqlSession, SqlSessionTemplate.<span style="color: #0000ff;">this</span><span style="color: #000000;">.sqlSessionFactory);
</span><span style="color: #008080;">35</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">36</span> 
<span style="color: #008080;">37</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">38</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> unwrapped;
</span><span style="color: #008080;">39</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">40</span> }</code></pre>

<p>看第15和16行，如果我们没有使用@Transation，Mapper方法执行完后，sqlSession将会提交，也就是说通过org.springframework.jdbc.datasource.DataSourceUtils#fetchConnection获取到的Connection将会commit，相当于Connection是自动提交的，也就是说如果不使用@Transation，Mybatis将没有事务可言。</p>
<p>如果使用了@Transation呢？那在调用Mapper代理类的方法之前就已经通过Spring的事务生成了Connection并放入ThreadLocal，并且设置事务不自动提交，当前线程多个Mapper代理对象调用数据库操作方法时，将从ThreadLocal获取Spring创建的connection,在所有的Mapper方法调用完后，Spring事务提交或者回滚，到此mybatis的事务是怎么被spring管理的就显而易见了</p>
<p>还有文章开头的问题，为什么Mybtis中要配置dataSource，Spring的事务中也要配置dataSource？</p>
<p>因为Spring事务在没调用Mapper方法之前就需要开一个Connection，并设置事务不自动提交，那么transactionManager中自然要配置dataSource。那如果我们的Service没有用到Spring事务呢，难道就不需要获取数据库连接了吗？当然不是，此时通过SpringManagedTransaction调用org.springframework.jdbc.datasource.DataSourceUtils#getConnection#fetchConnection方法获取，并将dataSource作为参数传进去，实际上获取的Connection都是通过dataSource来获取的。</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>

</div><hr><script charset='utf-8' src='../../js/sming.js'></script></body></html>